<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>任务发布</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/base.css" />
		<link href="../css/mui.imageViewers.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../icont/iconfont.css" />
		<link rel="stylesheet" href="../css/flow.css">

	</head>

	<body>
		<section id="app" v-cloak>
			<header class="mui-bar mui-bar-nav">
				<div class="mui-pull-left lishi"><i class="iconFont"></i>教程</div>
				<h1 class="mui-title">任务发布</h1>
			</header>
			<div class="mui-content">

				<!-- tabs切换 -->
				<div class="tabsBox">
					<div :class="{ bgOrange: taskType==1}" @tap="changeTaskType(1)">流量任务</div>
					<div :class="{ bgYellow: taskType==2}" @tap="changeTaskType(2)">收藏任务</div>
					<div :class="{ bgAzure: taskType==3}" @tap="changeTaskType(3)">加购任务</div>
					<div :class="{ bgBlue: taskType==4}" @tap="changeTaskType(4)">淘宝直播</div>
				</div>
				<div class="mainTop">
					<!-- 流量任务类型 -->
					<div class="flowBox">
						<div class="title">
							<i class="icon iconType"></i>
							<div>任务类型</div>
						</div>
						<!-- 流量任务 -->
						<div class="typesBox" v-if="taskType==1">
							<div :class="{active:priceType==0}">APP 流量</div>
							<div :class="{active:priceType==1}">PC 流量</div>
							<div :class="{active:priceType==2}">直访流量</div>
						</div>
						<!-- 收藏任务 -->
						<div class="typesBox" v-else-if="taskType==2">
							<div :class="{active:priceType==3}">搜索收藏</div>
							<div :class="{active:priceType==6}">商品收藏</div>
							<div :class="{active:priceType==7}">店铺收藏</div>
							<div :class="{active:priceType==9}">商品点赞</div>
						</div>
						<!-- 加购任务 -->
						<div class="typesBox" v-else-if="taskType==3">
							<div :class="{active:priceType==10}">搜索加购</div>
							<div :class="{active:priceType==11}">直接加购</div>
						</div>
						<!-- 淘宝直播 -->
						<div class="typesBox" v-else>
							<div :class="{active:priceType==12}">达人关注</div>
							<div :class="{active:priceType==14}">微淘点赞</div>
							<div :class="{active:priceType==17}">观看人数</div>
						</div>
					</div>


					<!-- 任务日期 -->
					<div class="flowBox">
						<div class="title">
							<i class="icon iconDate"></i>
							<div>任务日期</div>
						</div>
						<div class="timeBox">
							<div class="dateBox" @tap="setOrderTime(23,1)">
								<span>{{taskDateStart}}</span>
								<i class="icon"></i>
							</div>
							<div class="until">—</div>
							<div class="dateBox" @tap="setOrderTime(23,2)">
								<span>{{taskDateEnd}}</span>
								<i class="icon"></i>
							</div>
						</div>
						<ul>
							<li>快速选择：</li>
							<li v-for="(item,index) in dateList" :class="{active:fastDay==item}" @tap="changeFastDay(item)">{{item}}天</li>
						</ul>
						<div class="totalTime">任务时长 <span>{{duration}}</span> 天，每天发布 <span>{{dayNum}}</span> 个任务量，此次合计发布<span>{{duration*dayNum}}</span>个任务</div>
					</div>
				</div>

				<div class="calendarBox">
					<div class="title">
						<i class="icon iconType"></i>
						<div>任务信息</div>
					</div>
					<div class="calendarItem" v-for="(item,index) in periodList">
						<ul>
							<!-- 流量任务 收藏任务  加购任务 -->
							<li v-if="taskType!==4">
								<label>商品链接</label>
								<div class="inputBox">
									<input class="inputItem" v-model="item.target" type="text" placeholder="请输入链接或淘口令" />
								</div>
							</li>
							<li v-if="taskType!==4">
								<label>关键词{{index+1}}</label>
								<div class="inputBox">
									<input class="inputItem" v-model="item.keyword" type="text" placeholder="请输入关键词" />
								</div>
								<button class="" type="button">查排名</button>
							</li>
							<!-- 淘宝直播 -->
							<li v-if="taskType==4">
								<label>店铺链接</label>
								<div class="inputBox">
									<input class="inputItem" v-model="item.target" type="text" placeholder="请输入链接或淘口令" />
								</div>
							</li>

							<li>
								<label v-if="taskType==1">访客数量</label>
								<label v-else-if="taskType==2">收藏数量</label>
								<label v-else-if="taskType==3">加购数量</label>
								<label v-else>粉丝数量</label>
								<div class="inputBox">
									<div class="num-count">
										<div class="count-desc" @tap="setOrderNum(1,index)">-</div>
										<input class="count-input" type="number" @change="(e)=>{changeTotal(e,index)}" v-model="item.infoNum" pattern="[0-9]*" />
										<div class="count-add" @tap="setOrderNum(2,index)">+</div>
									</div>
								</div>
								<button class="" type="button">时段</button>
							</li>
						</ul>

						<!-- 24h -->
						<div class="periodBox">
							<ul>
								<li v-for="(ite,idex) in numList[index]">
									<div class="hours">{{idex>=10?idex:"0"+idex}}:00</div>
									<div class="percentage">{{(ite.size/item.infoNum*100).toFixed(2)}}%</div>
									<div class="hoursInput">
										<input type="text" v-if="!ite.isShow" disabled value="0">
										<input type="number" v-else @change="(e)=>{changeNumItem(e,index,idex)}" v-model="ite.size" />
									</div>
								</li>
							</ul>
						</div>

						<div class="totalTime">共 <span>{{item.infoNum}}</span> 个任务，已分配 <span>{{item.allocationNum}}</span> 个，剩余未分配<span
							 class="renText">{{item.infoNum-item.allocationNum}}</span>个任务</div>
						<div class="fillBox">
							<i></i>
							<div class="active">随机填充</div>
							<div @tap="goToLishi">历史发布</div>
						</div>
						<div class="delBox">
							<div>删除</div>
						</div>
					</div>
					<div class="addBox" @tap="addPeriod">添加</div>
				</div>

				<div class="ulBox">
					<ul>
						<li>
							<label>浏览时间</label>
							<div @tap="choseBrowse">
								<span>{{browse_time}}</span>
								<i></i>
							</div>
						</li>
						<li>
							<label>浏览深度</label>
							<div @tap="choseDepth">
								<span>{{depthText}}</span>
								<i></i>
							</div>
						</li>
						<li>
							<label>任务备注</label>
							<div class="inputBox">
								<input type="text" placeholder="请输入备注（可不填）">
							</div>
						</li>
					</ul>
				</div>

				<div class="priceInfo">
					<div class="title">
						<i class="icon iconPrice"></i>
						<div>计费方式</div>
					</div>
					<div>任务耗时: <span>{{browse_time}}</span> 秒,单次消费<span>¥{{priceList[priceType]}}</span></div>
					<div>合计消费: <span>￥{{payable.toFixed(2)}}</span></div>
					<div class="referBox">
						<div>应付金额：<span>￥{{payable.toFixed(2)}}</span></div>
						<div class="referBtn" @tap="addFlow">提交订单</div>
					</div>
				</div>
			</div>
		</section>

		<script src="../js/jquery-3.2.1.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script src="../js/mui.zoom.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script src="../js/castapp.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/browser.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/axios.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/qs.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/config.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/api.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/storage.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/babel">

			var app = new Vue({
				el:'#app',
				data(){
					return {
						taskType:1,
						startHour:24,//当前小时
						taskDateStart:this.changeTomorrow(0),//任务开始日期
						taskDateEnd:this.changeTomorrow(1),//任务结束日期
						dateList:[1,3,7,10,15,30],//快速选择时间列表
						fastDay:1,//天数
						periodList:[this.periodItem()],
						numList:[this.numItem()],
						duration:1,//任务时长
						// 0-app流量，1-pc流量，2-直访流量
						priceType:0,//价格类型
						priceList:{},//单次消费价格列表
						browse_time:"100-180",//浏览时间
						
						depth:1,//浏览深度
						depthText:"不浏览",
						
						depthList:[{
							value:0,
							text:'100-180'
						},{
							value:1,
							text:'180-280'
						},{
							value:2,
							text:'280-380'
						},{
							value:3,
							text:'380-480'
						}],
						
						browseList:[
							{
								value:0,
								text:'不浏览'
							},{
								value:1,
								text:'随机浏览'
							},{
								value:2,
								text:'深度浏览'
							}
						]
					}
				},
				computed:{
					
					dayNum(){//每天发布任务数
						let num=0;
						this.periodList.map(item=>{
							num+=parseInt(item.infoNum);
						});
						return num;
					},
					payable(){//应付金额
						return this.duration*this.dayNum*this.priceList[this.priceType]
					}
					
				},
				
				created(){
					mui.init();
					
					mui.plusReady(function(){
						
					});
					var that=this;
					that.changeDistribution(0);
					this.getPrice();
					
				},
				watch:{
				
				},
				methods:{
					periodItem(){
						return {
							links:"",//链接
							keyword:"",//关键词
							infoNum:100,//数量
							allocationNum:100,//已分配
							target:"",//淘宝链接
							keyword:"",//关键词
							
						};
					},
					numItem(){
						return [
							{time:0,size:0,isShow:false},
							{time:1,size:0,isShow:false},
							{time:2,size:0,isShow:false},
							{time:3,size:0,isShow:false},
							{time:4,size:0,isShow:false},
							{time:5,size:0,isShow:false},
							{time:6,size:0,isShow:false},
							{time:7,size:0,isShow:false},
							{time:8,size:0,isShow:false},
							{time:9,size:0,isShow:false},
							{time:10,size:0,isShow:false},
							{time:11,size:0,isShow:false},
							{time:12,size:0,isShow:false},
							{time:13,size:0,isShow:false},
							{time:14,size:0,isShow:false},
							{time:15,size:0,isShow:false},
							{time:16,size:0,isShow:false},
							{time:17,size:0,isShow:false},
							{time:18,size:0,isShow:false},
							{time:19,size:0,isShow:false},
							{time:20,size:0,isShow:false},
							{time:21,size:0,isShow:false},
							{time:22,size:0,isShow:false},
							{time:23,size:0,isShow:false}
						]
					},
					// 处理初始分配
					changeDistribution(index){
						var that=this;
						var time = new Date();
						that.startHour =parseInt(time.getHours()) ;
						var arr=that.getRandomMoney(that.periodList[index].infoNum,24 - that.startHour);
						arr.map((item)=>{
							that.numList[index].forEach((ite,index)=>{
								
								if(ite.time==item.time){
									ite.isShow=true;
									ite.size=item.size;
								}
							})
						})
					},
					// 修改单个任务信息数量
					setOrderNum(type,index){
						if(type==1){
							this.periodList[index].infoNum-=1;
						}else{
							this.periodList[index].infoNum+=1;
						}
						
						// this.changeDistribution(index);
					},
					changeTotal(e,index){
						
						this.periodList[index].infoNum=parseInt( e.target.value);
						// this.changeDistribution(index);
						
					},
					// 修改时段的input
					changeNumItem(e,index,idex){
						this.numList[index][idex].size=e.target.value;
						console.log(this.numList[index][idex]);
						let total=0;
						this.numList[index].map(item=>{
							total+=parseInt(item.size);
						});
						if(this.periodList[index].infoNum<total){
							this.periodList[index].infoNum=total;
						}
						
						this.periodList[index].allocationNum=total;
						
					},
					
					// 添加任务详情
					addPeriod(){
						this.periodList.push(this.periodItem());
						let length=this.periodList.length-1;
						
						this.numList.push(this.numItem());
						this.changeDistribution(length);
					},
					
					changeTaskType(type){
						this.taskType=type;
					},
					// 获取价格
					getPrice(){
						let that=this;
						Axios.flowPost('/api/liuliang/price',{
							token:storage.get("token") || "35b49ed8-543d-475f-a1be-22560ed9141c",
							
						}).then(function(res){
							console.log(res);
							if(res.code==1){
								that.priceList=res.data;	
							}
						});
					},
					// 添加流量任务
					addFlow(){
						let that=this;
						
						// 处理发布量
						let numStringArr=[];
						that.numList.map(item=>{
							let numArr=[];
							item.map(ite=>{
								numArr.push(ite.size);
							});
							numStringArr.push(numArr.join(","))
						});
						
						
						
						var isAll=true;
						// 
						for(let i=0;i<that.periodList.length;i++){
							
							if(isAll){
								Axios.flowPost('/api/liuliang/add',{
									token:storage.get("token") || "5d62eeec-e67f-45a8-9275-76a30a3a179f",
									count:that.duration*that.dayNum,
									hour:numStringArr[i],
									begin_time:that.taskDateStart,
									type:that.priceType,
									target:that.periodList[i].target,
									keyword:that.periodList[i].keyword,
									browse_time:that.browse_time,
									depth:that.depth,
									
								}).then(function(res){
									
									if(res.code==1){
										
									}else{
										console.log(res);
										isAll=false;
									}
								});
							}else{
								return;
							}
							
						}
						
						// that.periodList.map((item,index)=>{
							
							
						// 	Axios.flowPost('/api/liuliang/add',{
						// 		token:storage.get("token") || "5d62eeec-e67f-45a8-9275-76a30a3a179f",
						// 		count:that.duration*that.dayNum,
						// 		hour:numStringArr[index],
						// 		begin_time:that.taskDateStart,
						// 		type:that.priceType,
						// 		target:item.target,
						// 		keyword:item.keyword,
						// 		browse_time:that.browse_time,
						// 		depth:that.depth,
								
						// 	}).then(function(res){
						// 		console.log(res);
						// 		if(res.code==0){
									
						// 		}else{
						// 			isAll=false;
						// 		}
						// 	});
						// });
					},
					
					// 设置时间
					setOrderTime(item,type){
						var time = new Date();
						var startHour = time.getHours();
						var startMinutes = time.getMinutes();
						let that=this;
						
						this.timePicker = new mui.DtPicker({
							type: "date", //设置日历初始视图模式
							// customData: {
							// 	h: getTime(startHour,24),
							// 	i: getTime(startMinutes,59)
							// }//时间/日期别名
						});
						this.timePicker.show((selectItems) => {
							console.log(selectItems);
							if(type==1){
								
								if(that.taskDateEnd&& selectItems.value >that.taskDateEnd){
									ca.prompt('开始时间不能大于结束时间！');
									return;
								}
								
								that.taskDateStart = selectItems.value;
								
							}else{
								if(that.taskDateStart&& selectItems.value<that.taskDateStart){
									ca.prompt('结束时间不能小于开始时间！');
									return;
								}
								that.taskDateEnd = selectItems.value;
								
							}
							this.timePicker.dispose();
							
							let startTime = new Date(that.taskDateStart); // 开始时间
							let endTime = new Date(that.taskDateEnd); // 结束时间
							let usedTime = endTime - startTime; // 相差的毫秒数
							let days = Math.floor(usedTime / (24 * 3600 * 1000)); // 计算出天数
							if(days>0){
								that.duration=days;
								console.log(days);
							}
							
						});
					},
					// 选择浏览时间
					choseBrowse(){
						
						var that = this;
						var picker = new mui.PopPicker();
						picker.setData(that.depthList);
						
						// 点击取消按钮关闭滚动锁定状态
						var btn = $("button.mui-poppicker-btn-cancel")[0];
						btn.addEventListener('tap',function () {
							picker.dispose();
						});
						
						picker.show(function (selectItems) {
							console.log(selectItems);
							that.browse_time=selectItems[0].text;
							
							picker.dispose();
						})
					},
					// 选择浏览深度
					choseDepth(){
						var that = this;
						var picker = new mui.PopPicker();
						picker.setData(that.browseList);
						
						// 点击取消按钮关闭滚动锁定状态
						var btn = $("button.mui-poppicker-btn-cancel")[0];
						btn.addEventListener('tap',function () {
							picker.dispose();
						});
						
						picker.show(function (selectItems) {
							console.log(selectItems);
							that.depth=selectItems[0].value;
							that.depthText=selectItems[0].text;
							picker.dispose();
						})
					},
					changeFastDay(type){
						this.fastDay=type;
						this.taskDateEnd=this.changeTomorrow(type);
						this.duration=type;
						
					},
					// 随机分配任务数量
					getRandomMoney(remainMoney, remainSize) {
						let that=this;
						let moneyList = [];
						const min = 1;
						let max, money;
						while (remainSize > 1) {
							max = remainMoney / remainSize * 2;
							money = parseInt(Math.random() * max);
							money = money < 1 ? 1 : money;
							money = Math.round(money * 100) / 100;
							// moneyList.push(money);
							moneyList.push({time:that.startHour++,size:money});
							
							remainSize--;
							remainMoney -= money;
						}
				
						moneyList.push({time:that.startHour++,size:Math.round(remainMoney * 100) / 100});
						return moneyList;
					},
					goToLishi(){
						openWebview({
							url:"./flow/task_lishi.html?",
							id:'task_lishi.html'
						})
					},
					
					
					// 修改天数
					changeTomorrow(days){
						var time = new Date().getTime() + 24 * 60 * 60 * 1000 * days;
						var yesterday = new Date(time);
						var month = yesterday.getMonth();
						var day = yesterday.getDate();
						yesterday =
							yesterday.getFullYear() +
							'-' +
							(yesterday.getMonth() > 9 ? yesterday.getMonth() + 1 : '0' + (yesterday.getMonth() + 1)) +
							'-' +
							(yesterday.getDate() > 9 ? yesterday.getDate() : '0' + yesterday.getDate());
						
						return yesterday;
					}
					
					
				},
				
			});
			
		</script>
	</body>

</html>
